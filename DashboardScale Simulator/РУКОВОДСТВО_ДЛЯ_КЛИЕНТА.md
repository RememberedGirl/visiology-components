# Руководство по эмуляции поведения дашборда Visiology

## Описание проблемы

При масштабировании дашборда Visiology использует CSS `transform: scale()` для элемента `.va-dashboard-container`. Это создает проблему с всплывающими элементами DevExtreme (filterRow, headerFilter, popup и др.), потому что:

1. DevExtreme использует `getBoundingClientRect()` для позиционирования всплывающих элементов
2. `getBoundingClientRect()` возвращает координаты в viewport, но не учитывает CSS transform родительских элементов
3. При масштабе отличном от 100%, всплывающие элементы отображаются в неправильных позициях

## Архитектура масштабирования Visiology

Дашборд Visiology работает следующим образом:

1. **Фиксированное разрешение листа**: 1920x1080px (или другое заданное)
2. **Масштабирование**: Применяется CSS transform через переменные
   ```css
   .va-dashboard-container {
     --zoom-scale: 1;
     transform: scale(var(--zoom-scale));
     transform-origin: left top;
   }
   ```
3. **Режимы отображения**:

   - `FitInPage` - масштабирование как object-fit: contain (весь лист виден)
   - `FitInWidth` - масштабирование по ширине
   - `ActualSize` - без масштабирования (100%)

4. **data-scale-value атрибут**: Хранит текущий масштаб для использования в пропатченном DevExtreme

## Решение

Предоставляются 2 файла:

### 1. visiology-dashboard-emulator.html

Базовая утилита-эмулятор с API:

```javascript
// Глобальный объект
window.VisiologyDashboard;

// Методы:
VisiologyDashboard.setMode("FitInPage" | "FitInWidth" | "ActualSize");
VisiologyDashboard.getZoomScale(); // Возвращает текущий масштаб
VisiologyDashboard.getScaledRect(element); // Возвращает rect с учетом масштаба
VisiologyDashboard.patchDevExtremeGrid(gridInstance); // Патч для конкретного грида
VisiologyDashboard.adjustPopupPosition(popup); // Ручная корректировка popup
```

### 2. devextreme-integration-example.html

Полный рабочий пример с DevExtreme DataGrid, демонстрирующий:

- Автоматическую корректировку всплывающих элементов
- Правильное позиционирование filterRow и headerFilter
- Работу при изменении размера окна
- Переключение режимов масштабирования

## Как использовать

### Вариант 1: Автоматический патч (рекомендуется)

```javascript
// Инициализируем эмулятор
window.VisiologyDashboard = new VisiologyDashboardEmulator();

// Включаем автоматический патч всех popup
VisiologyDashboard.patchDevExtremePopups();

// Инициализируем грид с конфигурацией
$("#dataGrid").dxDataGrid(VisiologyDashboard.getGridConfiguration({
    dataSource: data,
    columns: [...],
    filterRow: { visible: true },
    headerFilter: { visible: true }
}));
```

### Вариант 2: Ручная настройка

```javascript
$("#dataGrid").dxDataGrid({
    dataSource: data,
    columns: [...],
    filterRow: { visible: true },
    headerFilter: { visible: true },
    onContentReady: function(e) {
        const gridElement = e.element[0];

        gridElement.addEventListener('click', function(event) {
            if (event.target.closest('.dx-header-filter')) {
                setTimeout(() => {
                    VisiologyDashboard.adjustAllPopups();
                }, 50);
            }
        });
    }
});
```

## Структура HTML

Необходимая структура для корректной работы:

```html
<div id="va-dashboard-container">
  <div class="va-dashboard-container" data-scale-value="1">
    <div class="va-sheet-container" style="width: 1920px; height: 1080px;">
      <div id="va-widgets-container">
        <!-- Ваши виджеты здесь -->
        <div class="widget">
          <div id="dataGrid"></div>
        </div>
      </div>
    </div>
  </div>
</div>
```

## Обязательные CSS

```css
.va-dashboard-container {
  transform-origin: left top;
  --translate-x: 0;
  --translate-y: 0;
  --zoom-scale: 1;
  transform: translate(var(--translate-x), var(--translate-y)) scale(
      var(--zoom-scale)
    );
}
```

## Принцип работы корректировки

1. **MutationObserver** отслеживает создание новых popup элементов в DOM
2. При обнаружении `.dx-overlay-wrapper` вызывается `adjustPopupElement()`
3. Вычисляются корректные координаты:
   ```javascript
   const zoomScale = getZoomScale();
   const x = (rect.left - containerRect.left) / zoomScale;
   const y = (rect.top - containerRect.top) / zoomScale;
   ```
4. Применяется корректировка через CSS transform

## Важные замечания

1. **data-scale-value** - обязательный атрибут, используется для получения текущего масштаба
2. **transform-origin: left top** - обязательно для корректного масштабирования
3. Всплывающие элементы DevExtreme создаются вне контейнера виджета, поэтому требуется специальная обработка
4. При изменении масштаба все popup должны быть закрыты и пересозданы

## Альтернативное решение (если патч не работает)

Если автоматический патч не подходит, можно использовать настройку DevExtreme для рендеринга popup внутри контейнера:

```javascript
DevExpress.config({
  floatingActionButtonConfig: {
    position: {
      of: "#va-widgets-container",
    },
  },
});

// Для каждого грида
$("#dataGrid").dxDataGrid({
  // ...
  headerFilter: {
    visible: true,
    container: "#va-widgets-container", // Рендерим внутри масштабируемого контейнера
  },
});
```

## Тестирование

Для проверки корректности:

1. Откройте `devextreme-integration-example.html`
2. Измените размер окна браузера
3. Переключайте режимы масштабирования
4. Кликайте по иконкам фильтрации в заголовках грида
5. Проверьте, что popup появляются в правильных позициях

## Ограничения

1. Решение работает для DevExtreme версии 20.x и выше
2. Некоторые сложные popup (например, с вложенными меню) могут требовать дополнительной настройки
3. При очень малых масштабах (<50%) могут возникать проблемы с точностью позиционирования
