## КРИТИЧЕСКИЕ ОСОБЕННОСТИ VISIOLOGY:

### 1. Структура данных (w объект):
```javascript
// w.data.primaryData.items имеет СЛОЖНУЮ СТРУКТУРУ:
- keys: Array - измерения любой вложенности (например: ["Регион"], ["Регион", "Город"], ["Регион", "Город", "Клиент"])
- values: Array - числовые метрики (любое количество)
- formattedKeys: Array - форматированные названия для отображения
- formattedValues: Array - форматированные значения для отображения  
- cols: Array - полный список колонок (измерения + метрики)
- metadata: Array - описание метрик (dataType, columnType)
```

### 2. Паттерн работы с фильтрами:
```javascript
// GET → SET → LISTEN паттерн:
const widgetGuid = w.general.renderTo;
let currentFilter = '';

// 1. GET - один раз при загрузке
const initialFilters = visApi().getSelectedValues(widgetGuid);
currentFilter = initialFilters?.[0]?.join(' - ') || '';

// 2. SET - при действии пользователя - ВАЖНО: всегда передавать keys!
function handleClick(item) {
    // item.keys - ОБЯЗАТЕЛЬНО использовать для фильтра
    const filterToSet = currentFilter === item.formattedKeys.join(' - ') ? [] : [item.keys];
    visApi().setFilterSelectedValues(widgetGuid, filterToSet);
}

// 3. LISTEN - для обновлений UI
visApi().onSelectedValuesChangedListener(
    {guid: widgetGuid + '-listener', widgetGuid: widgetGuid},
    (event) => {
        currentFilter = event.selectedValues?.[0]?.join(' - ') || '';
        updateVisualization();
    }
);
```

### 3. Форматы фильтров:
```javascript
// Одиночный фильтр - ПЕРЕДАВАТЬ keys!
visApi().setFilterSelectedValues("widget-123", [["North"]]);

// Множественный выбор - ПЕРЕДАВАТЬ keys!
visApi().setFilterSelectedValues("widget-123", [["North"], ["South"]]);

// Иерархический фильтр - ПЕРЕДАВАТЬ полный путь keys!
visApi().setFilterSelectedValues("widget-123", [["North", "Chicago", "Customer1"]]);

// Очистка фильтра
visApi().setFilterSelectedValues("widget-123", []);
```

### 4. Создание контейнера:
```javascript
// Уникальный контейнер для избежания конфликтов:
w.general.text = `<div id="widget-${w.general.renderTo}" style="width:100%; height:100%;"></div>`;
TextRender({ text: w.general, style: {} });

// Использовать: document.getElementById(`widget-${w.general.renderTo}`)
```

### 5. Пример готовго виджета для visiology
```javascript

// Загрузка Highcharts
{
    const scriptId = w.general.renderTo + '-highcharts';
    if (!document.getElementById(scriptId)) {
        const script = document.createElement('script');
        script.id = scriptId;
        script.src = 'https://code.highcharts.com/highcharts.js';
        document.head.appendChild(script);
    }
}

// Данные из Visiology
const items = w.data.primaryData.items;
const keys = items[0].cols.slice(items[0].keys.length);
const categories = items.map(item => item.formattedKeys.join(' - '));

// 1. GET - один раз при загрузке
let currentFilter = '';
const initialFilters = visApi().getSelectedValues(w.general.renderTo);
currentFilter = initialFilters.length > 0 ? initialFilters.map(e => e.join(' - '))[0] : '';

// Создаем серии
const series = keys.map((key, j) => ({
    name: key,
    data: items.map((item, index) => ({
        y: item.values[j],
        marker: {
            lineWidth: currentFilter === categories[index] ? 2 : 0,
            lineColor: '#000'
        }
    }))
}));

// Создаем контейнер для графика
w.general.text = `<div id="chart-${w.general.renderTo}" style="width:100%; height:100%;"></div>`;
TextRender({
    text: w.general,
    style: {}
});

// Рендерим и инициализируем график
const chart = Highcharts.chart(`chart-${w.general.renderTo}`, {
    xAxis: { categories },
    series,
    plotOptions: {
        series: {
            point: {
                events: {
                    click: function() {
                        // 2. SET - при действии пользователя
                        const categoryArr = categories[this.index];
                        let category = [];
                        if (currentFilter !== categoryArr) {
                            category = [categoryArr.split(' - ')];
                        }
                        visApi().setFilterSelectedValues(w.general.renderTo, category);
                    }
                }
            }
        }
    }
});

// 3. LISTEN - для обновлений UI
visApi().onSelectedValuesChangedListener(
    {
        guid: w.general.renderTo + '-highcharts-listener',
        widgetGuid: w.general.renderTo
    },
    function(event) {
        // Обновляем текущий фильтр из события
        currentFilter = event.selectedValues && event.selectedValues.length > 0
            ? event.selectedValues.map(e => e.join(' - '))[0]
            : '';

        // Обновляем обводку всех точек
        chart.series.forEach((series) => {
            series.data.forEach((point, pointIndex) => {
                point.update({
                    marker: {
                        lineWidth: currentFilter === categories[pointIndex] ? 2 : 0,
                        lineColor: '#000'
                    }
                }, false);
            });
        });

        // Перерисовываем график один раз
        chart.redraw();
    }
);


```

## ВХОДНЫЕ ДАННЫЕ ДЛЯ ГЕНЕРАЦИИ:

### 1. Библиотека визуализации:
[Highcharts/ECharts/D3.js/Chart.js/Leaflet/Three.js/другая]

### 2. Тип визуализации:
[line/bar/pie/scatter/treemap/network/map/3d/etc]

### 3. Абстрактный пример визуализации (НЕ привязанный к данным):
```javascript
[Предоставьте абстрактный пример работы библиотеки]
```

### 4. Преобразование данных (АБСТРАКТНОЕ):
[Как преобразовать ЛЮБЫЕ w.data.primaryData.items в формат для визуализации?]
- Любое количество measurements (keys)
- Любое количество metrics (values)
- Любая вложенность иерархии

### 5. Интерактивность:
- Кликабельные элементы: [какие?]
- Визуальное выделение: [как?]
- Toggle логика: [да/нет]

## ТРЕБУЕМЫЙ ВЫВОД:
Полный JS код виджета Visiology с поддержкой ЛЮБОЙ структуры данных и соблюдением ВСЕХ особенностей платформы. Кроме кода ничего не пиши. 
