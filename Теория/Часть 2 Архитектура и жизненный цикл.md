# Часть 2: Архитектура и жизненный цикл**
##  2.1 Жизненный цикл виджета
### Полное описание этапов
### Управление состоянием

## 2.2 Структура DOM виджета
### Стандартная HTML структура
### CSS классы и стилизация
### Манипуляции с DOM

## 2.3 Объект данных `w` - полный разбор
`w.data.primaryData.items` - представляет собой массив объектов данных,
сформированный в результате агрегации и группировки в OLAP-кубе системы бизнес-аналитики.
Каждый элемент массива содержит сгруппированные данные по определенным измерениям с соответствующими метриками.

```javascript
w.data.primaryData.items = [
    { /* объект данных 1 */ },
    { /* объект данных 2 */ },
    // ... n объектов
]
```

Структура элемента данных

```javascript

item = {
    "keys": Array,           // Массив ключей группировки
    "values": Array,         // Массив числовых значений метрик
    "items": Array,          // Массив для вложенных данных
    "metadata": Array,       // Метаданные о колонках
    "cols": Array,           // Порядок и названия колонок
    "formattedKeys": Array,  // Форматированные ключи для отображения
    "formattedValues": Array // Форматированные значения для отображения
}
```
### Детальное описание свойств

#### `keys: Array<string>`
**Назначение**: Ключи группировки (измерения)
- Содержит значения измерений, по которым производилась группировка данных
- Порядок элементов соответствует иерархии группировки
- Количество элементов может варьироваться в зависимости от уровня детализации

**Пример**:
```javascript
["Регион", "Город", "Клиент"]
```

#### `values: Array<number>`
**Назначение**: Числовые значения метрик
- Содержит агрегированные числовые показатели
- Порядок соответствует порядку метрик в `metadata`
- Типы данных: целые числа, числа с плавающей точкой

**Пример**:
```javascript
[1500.75, 450.50]
```

#### `items: Array`
**Назначение**: Контейнер для вложенных данных DrillDown

#### `metadata: Array<Object>`
**Назначение**: Описание структуры данных метрик

**Структура объекта метаданных**:
```javascript
{
    "columnName": string,      // Техническое имя колонки
    "displayName": string,     // Отображаемое имя для UI
    "tableName": string,       // Исходная таблица в БД
    "dataType": string,        // Тип данных ("Double", "Integer", "String", etc.)
    "columnType": number,      // Тип колонки (0 - dimension, 1 - measure)
    "min": number|null,        // Минимальное значение (опционально)
    "max": number|null         // Максимальное значение (опционально)
}
```

#### `cols: Array<string>`
**Назначение**: Определяет порядок и состав колонок
- Содержит полный список полей в правильном порядке
- Включает как измерения (keys), так и метрики (values)
- Используется для построения таблиц и визуализаций

**Пример**:
```javascript
["region", "city", "customername", "sales_amount", "unit_price"]
```

#### `formattedKeys: Array<string>`
**Назначение**: Форматированные версии ключей для отображения
- Содержит human-readable представление значений из `keys`
- Может включать локализацию, форматирование дат, etc.
- Используется непосредственно в пользовательском интерфейсе

#### `formattedValues: Array<string>`
**Назначение**: Форматированные версии значений для отображения
- Содержит отформатированные строковые представления числовых значений
- Включает разделители тысяч, валютные символы, проценты, etc.
- Учитывает региональные настройки форматирования

## Типы данных и значения

### Типы columnType в metadata:
- `0` - Измерение (Dimension) - категориальные данные для группировки
- `1` - Мера (Measure) - числовые данные для агрегации

### Поддерживаемые dataType:
- `"Double"` - Числа с плавающей точкой
- `"Integer"` - Целые числа
- `"String"` - Строковые значения
- ---
- `"DateTime"` - Дата и время
- `"Boolean"` - Логические значения

## Методы работы с данными

### Базовые операции

#### Фильтрация по измерению
```javascript
function filterByDimension(items, dimensionIndex, value) {
    return items.filter(item => item.keys[dimensionIndex] === value);
}
```

#### Получение уникальных значений измерения
```javascript
function getUniqueDimensionValues(items, dimensionIndex) {
    return [...new Set(items.map(item => item.keys[dimensionIndex]))];
}
```

#### Агрегация по уровню
```javascript
function aggregateByLevel(items, level, metricIndex) {
    return items.reduce((acc, item) => {
        const key = item.keys[level];
        acc[key] = (acc[key] || 0) + item.values[metricIndex];
        return acc;
    }, {});
}
```

### Расширенные операции

#### Детализация (Drill-down)
```javascript
function drillDown(items, currentLevel, targetValue) {
    return items.filter(item => 
        item.keys.slice(0, currentLevel + 1).join('|') === targetValue
    );
}
```

#### Свертка (Roll-up)
```javascript
function rollUp(items, targetLevel) {
    const result = {};
    items.forEach(item => {
        const key = item.keys[targetLevel];
        if (!result[key]) result[key] = Array(item.values.length).fill(0);
        item.values.forEach((value, index) => {
            result[key][index] += value;
        });
    });
    return result;
}
```

#### Получение метаданных метрик
```javascript
function getMeasuresMetadata(items) {
    return items[0]?.metadata.filter(meta => meta.columnType === 1) || [];
}
```

## Пример использования

```javascript
// Получение структуры данных
const dataStructure = {
    items: w.data.primaryData.items,
    dimensions: w.data.primaryData.items[0]?.keys.map((_, index) => ({
        index,
        name: w.data.primaryData.items[0]?.cols[index]
    })),
    measures: getMeasuresMetadata(w.data.primaryData.items)
};

// Анализ данных по регионам
const regionalAnalysis = aggregateByLevel(
    w.data.primaryData.items, 
    0, // уровень региона
    0  // индекс метрики продаж
);

// Форматирование для отображения
const displayData = w.data.primaryData.items.map(item => ({
    dimensions: item.formattedKeys,
    metrics: item.formattedValues,
    rawValues: item.values
}));
```

## Особенности реализации

1. **Масштабируемость**: Структура поддерживает произвольное количество измерений и метрик
2. **Производительность**: Данные предварительно агрегированы для быстрого доступа
3. **Гибкость**: Поддерживает multiple levels of granularity
4. **Интернационализация**: Форматированные значения адаптированы под локаль пользователя

Эта структура оптимизирована для использования в системах бизнес-аналитики, дашбордах и отчетных системах.

item = 

### Детальная структура всех свойств

### Методы работы с данными